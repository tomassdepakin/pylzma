:100644 100644 79e166f... af96e52... M	py7zlib.py
:000000 100644 0000000... b1c8751... A	tests/data/lzma2.7z
:100644 100644 294376a... a4ccbca... M	tests/test_7zfiles.py

diff --git a/py7zlib.py b/py7zlib.py
index 79e166f..af96e52 100644
--- a/py7zlib.py
+++ b/py7zlib.py
@@ -28,6 +28,7 @@ from array import array
 from binascii import unhexlify
 from datetime import datetime
 import pylzma
+import lzma
 from struct import pack, unpack
 from zlib import crc32
 import zlib
@@ -140,6 +141,7 @@ COMPRESSION_METHOD_MISC          = unhexlify('04')  # '\x04'
 COMPRESSION_METHOD_MISC_ZIP      = unhexlify('0401')  # '\x04\x01'
 COMPRESSION_METHOD_MISC_BZIP     = unhexlify('0402')  # '\x04\x02'
 COMPRESSION_METHOD_7Z_AES256_SHA256 = unhexlify('06f10701')  # '\x06\xf1\x07\x01'
+COMPRESSION_METHOD_LZMA2         = unhexlify('21')  # '\x21'
 
 # number of seconds between 1601/01/01 and 1970/01/01 (UTC)
 # used to adjust 7z FILETIME to Python timestamp
@@ -584,6 +586,7 @@ class ArchiveFile(Base):
         self._decoders = {
             COMPRESSION_METHOD_COPY: '_read_copy',
             COMPRESSION_METHOD_LZMA: '_read_lzma',
+            COMPRESSION_METHOD_LZMA2: '_read_lzma2',
             COMPRESSION_METHOD_MISC_ZIP: '_read_zip',
             COMPRESSION_METHOD_MISC_BZIP: '_read_bzip',
             COMPRESSION_METHOD_7Z_AES256_SHA256: '_read_7z_aes256_sha256',
@@ -628,9 +631,6 @@ class ArchiveFile(Base):
         data = ''
         idx = 0
         cnt = 0
-        properties = coder.get('properties', None)
-        if properties:
-            decompressor.decompress(properties)
         total = self.compressed
         if not input and total is None:
             remaining = self._start+size
@@ -671,15 +671,28 @@ class ArchiveFile(Base):
         return data[self._start:self._start+size]
     
     def _read_lzma(self, coder, input, level):
-        size = self._uncompressed[level]
-        dec = pylzma.decompressobj(maxlength=self._start+size)
+        properties = coder.get('properties', None)
+        lzma_props = lzma._decode_filter_properties(lzma.FILTER_LZMA1, properties)
+        dec = lzma.LZMADecompressor(format=lzma.FORMAT_RAW, filters=[lzma_props])
         try:
             return self._read_from_decompressor(coder, dec, input, level, checkremaining=True, with_cache=True)
-        except ValueError:
+        except lzma.LZMAError:
             if self._is_encrypted():
                 raise WrongPasswordError('invalid password')
             
             raise
+
+    def _read_lzma2(self, coder, input, level):
+        properties = coder.get('properties', None)
+        lzma_props = lzma._decode_filter_properties(lzma.FILTER_LZMA2, properties)
+        dec = lzma.LZMADecompressor(format=lzma.FORMAT_RAW, filters=[lzma_props])
+        try:
+            return self._read_from_decompressor(coder, dec, input, level, checkremaining=True, with_cache=True)
+        except lzma.LZMAError:
+            if self._is_encrypted():
+                raise WrongPasswordError('invalid password')
+
+            raise
         
     def _read_zip(self, coder, input, level):
         dec = zlib.decompressobj(-15)
diff --git a/tests/data/lzma2.7z b/tests/data/lzma2.7z
new file mode 100644
index 0000000000000000000000000000000000000000..b1c875196e37aa23c3ecf7345e839787fee957a3
GIT binary patch
literal 221
zcmXr7+Ou9=hJj_42givy3=p6QrEhO)w|v0h$e<s~pe4nro+7!yqWDy|u)=yP>E7u-
zYLtCnzLqhr-nh;EuVSUkyJzcdHf+|oA3f{17f64jG5b3Hi&;k(ESRvMJnpE2#3bo;
zD<Trbjl#ud{`y!|GAlplp^Em(E{XE9mDyg;?z+`x?_6f6acM;!qtHIX*Cy+hoPLzN
z()5-;E7!}(OR56PANKW07w~5<zqKjn$*uT_F)R$?Z03xdsSNDgj0}v*%#4hzu?zwX
Q3_J~OT#VK0gd-Rj0B`wGfB*mh

literal 0
HcmV?d00001

diff --git a/tests/test_7zfiles.py b/tests/test_7zfiles.py
index 294376a..a4ccbca 100644
--- a/tests/test_7zfiles.py
+++ b/tests/test_7zfiles.py
@@ -25,7 +25,6 @@
 from datetime import datetime
 import errno
 import os
-import pylzma
 from py7zlib import Archive7z, NoPasswordGivenError, WrongPasswordError, UTC
 import sys
 import unittest
@@ -195,6 +194,10 @@ class Test7ZipFiles(unittest.TestCase):
         # test loading of copy compressed files
         self._test_archive('copy.7z')
 
+    def test_lzma2(self):
+        # test loading of lzma2 compressed files
+        self._test_archive('lzma2.7z')
+
     def test_regress_1(self):
         # prevent regression bug #1 reported by mail
         fp = self._open_file(os.path.join(ROOT, 'data', 'regress_1.7z'), 'rb')
